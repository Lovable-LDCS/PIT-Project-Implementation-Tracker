// QA Dashboard Functions
// Comprehensive system health monitoring and continuous improvement

(function() {
  'use strict';

  // QA State
  const qaState = {
    lastRun: null,
    results: [],
    categories: {},
    currentFilter: 'all'
  };

  // Category mapping from requirements.json to dashboard categories
  const categoryMapping = {
    'architecture': 'code',
    'environment': 'code',
    'typeSafety': 'code',
    'buildIntegrity': 'code',
    'unitTests': 'code',
    'e2eTests': 'code',
    'scriptIntegrity': 'code',
    'routeSmokeTests': 'wiring',
    'sidebarNavigation': 'wiring',
    'runtimeRenderingValidation': 'runtime',
    'timingAndSequencing': 'performance',
    'completeWiringValidation': 'wiring',
    'timelinesCompliance': 'ui',
    'enhancedTimelinesRequirements': 'ui',
    'projectsCompliance': 'ui',
    'rbacCompliance': 'security',
    'rbacMatrix': 'security',
    'roleBasedSidebarVisibility': 'security',
    'workItemDetail': 'ui',
    'evidenceUpload': 'ui',
    'ganttView': 'ui',
    'auditLog': 'data',
    'notifyPreferences': 'ui',
    'importWizard': 'data',
    'templatesLibrary': 'ui',
    'inviteMembersPage': 'ui',
    'securityDashboardPage': 'security',
    'healthCheckerRoot': 'code',
    'deploymentVerification': 'deployment',
    'accessibilityCompliance': 'accessibility',
    'dataIntegrity': 'data'
  };

  // Layman's terms for check types
  const checkTypeLabels = {
    'file_exists': 'File must exist',
    'directory_exists': 'Directory must exist',
    'directory_not_empty': 'Directory must contain files',
    'json_valid': 'File must be valid JSON',
    'js_syntax_check': 'JavaScript must be syntactically correct',
    'element_exists': 'UI element must be present',
    'element_not_exists': 'UI element must not exist',
    'route_exists': 'Navigation route must work',
    'runtime_dom_check': 'Page must render content correctly',
    'function_execution_check': 'Functions must execute without errors',
    'navigation_rendering_check': 'Navigation must show pages correctly',
    'console_error_check': 'No JavaScript errors in console',
    'timing_check': 'Code must execute in correct order',
    'sequence_check': 'Steps must happen in correct sequence',
    'dependency_check': 'Required code must load first',
    'interaction_check': 'User interactions must work',
    'route_functional_check': 'Pages must be fully functional'
  };

  // Run all QA tests
  window.runAllQATests = async function() {
    const btn = document.querySelector('[data-testid="TID-QA-RUN-ALL"]');
    const testList = document.querySelector('[data-testid="TID-QA-TEST-LIST"]');
    
    if (!btn || !testList) return;

    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<span class="icon">⏳</span> Running Tests...';
    testList.innerHTML = '<div class="qa-loading"><div class="qa-loading-spinner"></div><p>Running comprehensive QA tests...</p></div>';

    try {
      // Load ACTUAL QA results from last-result.json (generated by run-qa.ps1)
      const response = await fetch('qa/last-result.json');
      
      if (!response.ok) {
        throw new Error('QA results not found. Please run: ./scripts/run-qa.ps1');
      }
      
      const qaResults = await response.json();
      
      // Process real test results
      const results = [];
      const categories = {
        code: { pass: 0, fail: 0 },
        wiring: { pass: 0, fail: 0 },
        security: { pass: 0, fail: 0 },
        deployment: { pass: 0, fail: 0 },
        ui: { pass: 0, fail: 0 },
        performance: { pass: 0, fail: 0 },
        runtime: { pass: 0, fail: 0 },
        accessibility: { pass: 0, fail: 0 },
        data: { pass: 0, fail: 0 },
        legacy: { pass: 0, fail: 0 }
      };

      // Map categories from run-qa.ps1 to dashboard categories
      const catMap = {
        'architecture': 'code',
        'build': 'code',
        'typeSafety': 'code',
        'unitTests': 'code',
        'wiring': 'wiring',
        'security': 'security',
        'deployment': 'deployment'
      };

      // Process actual check results from run-qa.ps1
      for (const check of qaResults.checks || []) {
        const category = catMap[check.category] || 'code';
        const passed = check.status === 'PASS';
        const failed = check.status === 'FAIL';
        const skipped = check.status === 'SKIP';
        
        results.push({
          id: check.id,
          name: check.name,
          description: check.message || check.details || check.name,
          category: category,
          severity: check.severity || 'medium',
          passed: passed,
          skipped: skipped,
          type: check.category
        });

        if (passed) {
          categories[category].pass++;
        } else if (failed) {
          categories[category].fail++;
        }
        // Don't count skipped in pass/fail
      }

      // Update state
      qaState.lastRun = new Date(qaResults.timestamp || Date.now());
      qaState.results = results;
      qaState.categories = categories;

      // Update UI
      updateDashboard();
      renderTestList(results);

    } catch (error) {
      console.error('QA test error:', error);
      testList.innerHTML = `<p class="text-danger">Error loading QA results: ${error.message}</p>
        <p class="text-muted">Run the QA script to generate results: <code>./scripts/run-qa.ps1</code></p>`;
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<span class="icon">▶</span> Run All QA Tests';
    }
  };

  // Note: executeCheck and checkForDuplicates functions removed
  // QA Dashboard now loads REAL results from qa/last-result.json
  // generated by scripts/run-qa.ps1 - NO MORE SIMULATED DATA

  // Get human-readable check description
  function getCheckDescription(check) {
    const typeLabel = checkTypeLabels[check.type] || 'Must pass validation';
    
    if (check.note) {
      return check.note.replace('CRITICAL:', '').replace('HIGH:', '').replace('MEDIUM:', '').trim();
    }
    
    if (check.description) {
      return check.description;
    }

    return `${typeLabel}: ${check.name}`;
  }

  // Update dashboard metrics
  function updateDashboard() {
    const results = qaState.results;
    const categories = qaState.categories;

    const total = results.length;
    const passed = results.filter(r => r.passed).length;
    const failed = total - passed;
    const healthPct = total > 0 ? Math.round((passed / total) * 100) : 0;

    // Update summary cards
    setText('TID-QA-HEALTH-PCT', `${healthPct}%`);
    setText('TID-QA-TOTAL-COUNT', total);
    setText('TID-QA-PASSED-COUNT', passed);
    setText('TID-QA-FAILED-COUNT', failed);

    // Update last run time
    if (qaState.lastRun) {
      setText('TID-QA-LAST-RUN', `Last run: ${qaState.lastRun.toLocaleTimeString()}`);
    }

    // Update category breakdowns
    for (const [category, stats] of Object.entries(categories)) {
      setText(`TID-QA-${category.toUpperCase()}-PASS`, stats.pass);
      setText(`TID-QA-${category.toUpperCase()}-FAIL`, stats.fail);
    }

    // Show/hide actions section
    const actionsSection = document.querySelector('[data-testid="TID-QA-ACTIONS-SECTION"]');
    if (actionsSection) {
      if (failed > 0) {
        actionsSection.removeAttribute('hidden');
        renderCorrectiveActions(results.filter(r => !r.passed));
      } else {
        actionsSection.setAttribute('hidden', '');
      }
    }
  }

  // Render test list
  function renderTestList(results) {
    const testList = document.querySelector('[data-testid="TID-QA-TEST-LIST"]');
    if (!testList) return;

    const filtered = filterResultsByState(results);
    
    if (filtered.length === 0) {
      testList.innerHTML = '<p class="text-muted">No tests match the current filter</p>';
      return;
    }

    testList.innerHTML = filtered.map(test => `
      <div class="qa-test-item">
        <div class="qa-test-status ${test.passed ? 'pass' : 'fail'}">
          ${test.passed ? '✅' : '❌'}
        </div>
        <div class="qa-test-content">
          <div class="qa-test-id">${test.id}</div>
          <div class="qa-test-name">${test.name}</div>
          <div class="qa-test-description">${test.description}</div>
          <span class="qa-test-category ${test.category}">${getCategoryLabel(test.category)}</span>
        </div>
      </div>
    `).join('');
  }

  // Filter tests by current state
  function filterResultsByState(results) {
    switch (qaState.currentFilter) {
      case 'failed':
        return results.filter(r => !r.passed);
      case 'passed':
        return results.filter(r => r.passed);
      default:
        return results;
    }
  }

  // Get category label
  function getCategoryLabel(category) {
    const labels = {
      code: 'Code Correctness',
      wiring: 'Wiring',
      security: 'Security',
      deployment: 'Deployment',
      ui: 'UI/UX',
      performance: 'Performance',
      runtime: 'Runtime',
      accessibility: 'Accessibility',
      data: 'Data',
      legacy: 'Duplicates/Legacy'
    };
    return labels[category] || category;
  }

  // Render corrective actions
  function renderCorrectiveActions(failedTests) {
    const actionsList = document.querySelector('[data-testid="TID-QA-ACTIONS-LIST"]');
    if (!actionsList) return;

    // Group by category
    const byCategory = {};
    failedTests.forEach(test => {
      if (!byCategory[test.category]) {
        byCategory[test.category] = [];
      }
      byCategory[test.category].push(test);
    });

    actionsList.innerHTML = Object.entries(byCategory).map(([category, tests]) => `
      <div class="qa-action-item">
        <div class="qa-action-title">${getCategoryLabel(category)}: ${tests.length} issue(s)</div>
        <ul class="qa-action-steps">
          ${tests.slice(0, 3).map(test => `<li>${test.name}</li>`).join('')}
          ${tests.length > 3 ? `<li><em>...and ${tests.length - 3} more</em></li>` : ''}
        </ul>
      </div>
    `).join('');
  }

  // Filter tests
  window.filterTests = function(filter) {
    qaState.currentFilter = filter;
    
    // Update button states
    document.querySelectorAll('.qa-filter-controls .btn').forEach(btn => {
      btn.removeAttribute('data-active');
    });
    event.target.setAttribute('data-active', 'true');

    // Re-render
    if (qaState.results.length > 0) {
      renderTestList(qaState.results);
    }
  };

  // Show drilldowns
  window.showHealthDrilldown = function() {
    filterTests('all');
    document.querySelector('[data-testid="TID-QA-DETAILS-SECTION"]').scrollIntoView({ behavior: 'smooth' });
  };

  window.showAllTests = function() {
    filterTests('all');
    document.querySelector('[data-testid="TID-QA-DETAILS-SECTION"]').scrollIntoView({ behavior: 'smooth' });
  };

  window.showPassedTests = function() {
    filterTests('passed');
    document.querySelector('[data-testid="TID-QA-DETAILS-SECTION"]').scrollIntoView({ behavior: 'smooth' });
  };

  window.showFailedTests = function() {
    filterTests('failed');
    document.querySelector('[data-testid="TID-QA-DETAILS-SECTION"]').scrollIntoView({ behavior: 'smooth' });
  };

  window.showCategoryDetails = function(category) {
    if (qaState.results.length === 0) {
      alert('Please run QA tests first');
      return;
    }

    const categoryTests = qaState.results.filter(r => r.category === category);
    const testList = document.querySelector('[data-testid="TID-QA-TEST-LIST"]');
    
    if (testList && categoryTests.length > 0) {
      renderTestList(categoryTests);
      testList.scrollIntoView({ behavior: 'smooth' });
    }
  };

  // Utility function
  function setText(testId, value) {
    const el = document.querySelector(`[data-testid="${testId}"]`);
    if (el) el.textContent = value;
  }

  console.log('QA Dashboard initialized');
})();
