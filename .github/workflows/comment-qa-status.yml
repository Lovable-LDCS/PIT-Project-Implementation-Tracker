name: "Comment QA Status on PR"

on:
  workflow_run:
    workflows: ["One Time Build QA Runner"]
    types:
      - completed

permissions:
  actions: read
  contents: read
  pull-requests: write

jobs:
  comment-status:
    if: ${{ github.event.workflow_run.conclusion != 'cancelled' }}
    runs-on: ubuntu-latest

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: qa-report-md
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract artifact
        run: |
          mkdir -p qa-report/qa
          if [ -f qa-report.zip ]; then
            unzip -o qa-report.zip -d qa-report || true
          fi
          ls -la qa-report || true
          ls -la qa-report/qa || true

      - name: Parse QA result and build summary
        id: parse
        run: |
          STATUS="RED"
          if [ -f qa-report/qa/report.md ]; then
            if grep -q "GREEN" qa-report/qa/report.md; then
              STATUS="GREEN"
            elif grep -q "AMBER" qa-report/qa/report.md; then
              STATUS="AMBER"
            fi
            # Convert newlines to %0A to avoid heredoc
            SUMMARY=$(head -n 20 qa-report/qa/report.md | sed 's/^/> /' | tr '\n' '%')
          else
            SUMMARY="QA report file not found"
          fi
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT

      - name: Find associated PR
        id: find-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open"
            });
            const pr = prs.find(pr => pr.head.sha === context.payload.workflow_run.head_sha);
            return pr ? pr.number : null;

      - name: Comment QA status on PR
        if: ${{ steps.find-pr.outputs.result != 'null' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const status = "${{ steps.parse.outputs.status }}";
            const summary = "${{ steps.parse.outputs.summary }}".replace(/%/g, "\n");
            const color = status === "GREEN" ? "ðŸŸ¢" : status === "AMBER" ? "ðŸŸ¡" : "ðŸ”´";
            const workflowUrl = "${{ github.event.workflow_run.html_url }}";
            const timestamp = new Date().toISOString();
            
            const body = `### ${color} QA Status: ${status}\n\n` +
              `**Time:** ${timestamp}\n` +
              `**Workflow:** [One Time Build QA Runner](${workflowUrl})\n\n` +
              `#### Summary:\n${summary}\n\n` +
              `---\n*Full report available in workflow artifacts*`;

            const prNumber = ${{ steps.find-pr.outputs.result }};
            
            // Find existing QA comment to update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const qaComment = comments.find(comment => 
              comment.body.includes('QA Status:') && comment.user.type === 'Bot'
            );
            
            if (qaComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: qaComment.id,
                body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body
              });
            }
